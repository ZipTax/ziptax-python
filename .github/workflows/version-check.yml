name: Version Bump Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

jobs:
  check-version-bump:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install packaging library
        run: |
          python -m pip install --upgrade pip
          pip install packaging toml

      - name: Get current version from PR
        id: pr-version
        run: |
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "PR Version: $VERSION"

      - name: Get base branch version
        id: base-version
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }} -- pyproject.toml
          BASE_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "Base Version: $BASE_VERSION"
          git checkout ${{ github.head_ref }} -- pyproject.toml

      - name: Compare versions
        id: compare
        run: |
          python - <<'EOF'
          import sys
          from packaging import version

          pr_version = "${{ steps.pr-version.outputs.version }}"
          base_version = "${{ steps.base-version.outputs.version }}"

          print(f"Base version: {base_version}")
          print(f"PR version: {pr_version}")

          pr_ver = version.parse(pr_version)
          base_ver = version.parse(base_version)

          if pr_ver <= base_ver:
              print(f"❌ ERROR: Version not bumped!")
              print(f"Current version ({pr_version}) must be greater than base version ({base_version})")
              sys.exit(1)
          else:
              print(f"✅ Version properly bumped: {base_version} → {pr_version}")
          EOF

      - name: Check version consistency
        run: |
          python - <<'EOF'
          import tomllib
          import sys

          # Read pyproject.toml version
          with open('pyproject.toml', 'rb') as f:
              pyproject_version = tomllib.load(f)['project']['version']

          # Read __init__.py version
          with open('src/ziptax/__init__.py', 'r') as f:
              for line in f:
                  if line.strip().startswith('__version__'):
                      init_version = line.split('=')[1].strip().strip('"\'')
                      break

          print(f"pyproject.toml version: {pyproject_version}")
          print(f"__init__.py version: {init_version}")

          if pyproject_version != init_version:
              print(f"❌ ERROR: Version mismatch!")
              print(f"pyproject.toml has {pyproject_version}")
              print(f"__init__.py has {init_version}")
              print(f"Both files must have the same version.")
              sys.exit(1)
          else:
              print(f"✅ Version consistent across files: {pyproject_version}")
          EOF

      - name: Validate semantic versioning format
        run: |
          python - <<'EOF'
          import re
          import sys
          from packaging import version

          pr_version = "${{ steps.pr-version.outputs.version }}"

          # Check if version is valid according to PEP 440
          try:
              version.parse(pr_version)
              print(f"✅ Version {pr_version} is valid PEP 440 format")
          except Exception as e:
              print(f"❌ ERROR: Invalid version format: {pr_version}")
              print(f"Error: {e}")
              sys.exit(1)

          # Additional check for semantic versioning pattern
          semver_pattern = r'^\d+\.\d+\.\d+(-[a-zA-Z0-9]+)?$'
          if re.match(semver_pattern, pr_version):
              print(f"✅ Version follows semantic versioning: {pr_version}")
          else:
              print(f"⚠️  Warning: Version {pr_version} doesn't follow strict semantic versioning (X.Y.Z[-label])")
              print(f"   This is allowed but not recommended")
          EOF

      - name: Check CHANGELOG update
        id: changelog
        run: |
          # Check if CHANGELOG.md has been modified in this PR
          git fetch origin ${{ github.base_ref }}
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -c "CHANGELOG.md" || echo "0")

          if [ "$CHANGED" -eq "0" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "⚠️  Warning: CHANGELOG.md has not been updated"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✅ CHANGELOG.md has been updated"
          fi

      - name: Add PR comment with version info
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prVersion = '${{ steps.pr-version.outputs.version }}';
            const baseVersion = '${{ steps.base-version.outputs.version }}';
            const changelogUpdated = '${{ steps.changelog.outputs.changed }}' === 'true';

            let body = `## Version Bump Check\n\n`;
            body += `| Item | Status |\n`;
            body += `|------|--------|\n`;
            body += `| Base version | \`${baseVersion}\` |\n`;
            body += `| PR version | \`${prVersion}\` |\n`;
            body += `| Version bumped | ✅ Yes |\n`;
            body += `| Version consistent | ✅ Yes |\n`;
            body += `| CHANGELOG updated | ${changelogUpdated ? '✅ Yes' : '⚠️ No'} |\n\n`;

            if (!changelogUpdated) {
              body += `> ⚠️ **Reminder**: Please update CHANGELOG.md with your changes.\n`;
            }

            body += `\n---\n`;
            body += `Version bump: \`${baseVersion}\` → \`${prVersion}\`\n`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Version Bump Check')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
